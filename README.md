# Umbreon for Swift

[![](https://tokei.rs/b1/github/lucka-me/umbreon-swift)](https://github.com/lucka-me/umbreon-swift)

Core components of Umbra Sphere.

## At a Glance

### Target [`UmbreonCore`](Sources/UmbreonCore)

This target provides most fundamental data definitions and access to [Falinks](https://github.com/lucka-me/falinks)-generated static database.

- [`AppData`](Sources/UmbreonCore/AppData): Data definitions and access to the static database of all regions
- [`UserData`](Sources/UmbreonCore/UserData): Data definitions for user-generated data like discovered cells and statistics of regions

This target (especially the data models) is expected to stay simple and stable as possible.

### Target [`UmbreonPersistence`](Sources/UmbreonPersistence)

This target provides abilities of modifying and importing user data.

- [`CellCollectionConvertible`](Sources/UmbreonPersistence/CellCollectionConvertible): Interfaces to convert file to cells
- [`Persistence`](Sources/UmbreonPersistence/Persistence.swift): Interface to modify database, including inserting discovered cells
- [`Tessellation`](Sources/UmbreonPersistence/Tessellation.swift): Interface to classify cells into regions, with cache feature

### Target [`UmbreonAppUI`](Sources/UmbreonAppUI)

This target provides UI components of Umbra Sphere App.

- [`MapDefaults`](Sources/UmbreonAppUI/MapDefaults): User defauls wrappers and settings form view
- [`MapFrameworks`](Sources/UmbreonAppUI/MapFrameworks): Unify some APIs of MapKit and Mapbox Map SDK
- [`UmbraMap`](Sources/UmbreonAppUI/UmbraMap): Component to display umbra on map
  - [`UmbraProvider/Dataset`](Sources/UmbreonAppUI/UmbraMap/UmbraProvider/Dataset): Interfaces to supply cells to `UmbraMap`
- [`SphereGeometryDemoMap`](Sources/UmbreonAppUI/SphereGeometryDemoMap): Component to display cell on map

## About Umbra Sphere

Umbra Sphere is a [proof-of-concept](https://en.wikipedia.org/wiki/Proof_of_concept) where we try to implement a [Fog-of-World](https://fogofworld.app)-like app with [S2 Geometry](https://github.com/google/s2geometry) as underlying technology.

Umbra Sphere is still under development, you may join the TestFlight [here](https://testflight.apple.com/join/PcmWvqUC).

Umbra Sphere will not be fully open-sourced, but we hope to open-source more core components to this repository when they are stable enough.

## Usage

To use the package in a SwiftPM project, add `https://github.com/lucka-me/umbreon-swift` to the dependencies of your package and target.

### Download Generated Resources

Both `UmbreonCore` and `UmbreonPersistence` require assets generated by [Falinks](https://github.com/lucka-me/falinks).

- Download manually
  1. Download the `falinks-generated-resources.aar` from [latest release](https://github.com/lucka-me/umbreon-swift/releases/latest)
  2. Extract the archive to `Sources/UmbreonCore/Resources/Generated` and `Sources/UmbreonPersistence/Resources/Generated`
- Download by command
  ```sh
  curl -s -L https://github.com/lucka-me/umbreon-swift/releases/latest/download/falinks-generated-resources.aar | aa extract -d ./
  ```

### Example

Here is a very simple example to present the `UmbraMap` and discover the world with `CLLocationUpdate`.

```swift
import SwiftUI
import UmbreonAppUI
import UmbreonCore
import UmbreonPersistence

struct ContentView : View {
    var body: some View {
        UmbraMap(dataset: .persistent(container: /* Your ModelContainer instance */))
            .task {
                let serviceSession = CLServiceSession(authorization: .always)
                let backgroundActivitySession = CLBackgroundActivitySession()
                let persistence = Persistence(
                    modelContainer: /* Your ModelContainer instance */,
                    tessellation: .init(cachePolicy: .init(countLimit: 2))
                )
                try? await CLLocationUpdate
                    .liveUpdates(.default)
                    .map(\.location?.coordinate)
                    .strideCells(
                        at: PartialCellCollection.detailedLevel,
                        breakWhenFurtherThan: 2_000
                    ) { @Sendable cells in
                        // Insert discovered cells to database
                        let inserted = try await persistence.insert(discovered: cells)
                        if inserted.area.value > .zero {
                            try await persistence.save()
                            // Notify the UmbraMap to update
                            await PersistentUmbraDataset.updated(inserted.cells)
                        }
                    }
            }
    }
}
```

## Platform Availability

As Umbra Sphere is designed for iOS and macOS, Umbreon is also designed for Apple platforms, and one of the dependency, `SphereGeometry` depends on the `simd` module of Apple platform, therefore it's not available on Windows or Linux yet.
